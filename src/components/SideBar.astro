---
import SideBarFooter from "./SideBarFooter.astro";
import { Image } from "astro:assets";
import SideBarMenu from "./SideBarMenu.astro";
const { sideBarActiveItemID } = Astro.props;
---

<div class="drawer-side z-40">
  <label for="my-drawer" class="drawer-overlay"></label>
  <aside class="px-2 pt-2 h-auto min-h-full w-[19rem] bg-base-200 text-base-content flex flex-col relative">
    <div id="logo-playground"></div>
    <div class="w-fit mx-auto mt-5 mb-6 relative z-10">
      <a href="/">
        <div class="avatar transition ease-in-out hover:scale-[102%] block m-auto">
          <div class="w-[8.5rem]">
            <Image class="mask mask-circle" format="webp" width={300} height={300} src="/john-dorion.jpg" alt="John Dorion" />
          </div>
        </div>
      </a>
    </div>
    <div class="relative z-10">
      <SideBarMenu sideBarActiveItemID={sideBarActiveItemID} />
    </div>
    <div class="flex-grow"></div>
    <div class="relative z-10">
      <SideBarFooter />
    </div>
  </aside>
</div>

<style>
  #logo-playground {
    position: absolute;
    inset: 0;
    overflow: hidden;
    z-index: 0;
    pointer-events: auto;
  }

  #logo-playground :global(.logo-particle) {
    position: absolute;
    pointer-events: auto;
    will-change: transform, opacity, filter;
    cursor: default;
    transition: filter 0.3s ease;
  }

  #logo-playground :global(.logo-particle:hover) {
    filter: drop-shadow(0 0 8px rgba(192, 163, 110, 0.6));
  }

  #logo-playground :global(.logo-particle path) {
    fill: #C0A36E;
    fill-rule: evenodd;
  }
</style>

<script>
  function initLogoAnimation() {
    const playground = document.getElementById('logo-playground');
    if (!playground || playground.dataset.initialized) return;
    playground.dataset.initialized = 'true';

    const PARTICLE_COUNT = 8;

    interface Particle {
      el: SVGSVGElement;
      x: number;
      y: number;
      baseX: number;
      size: number;
      baseOpacity: number;
      riseSpeed: number;
      driftAmplitude: number;
      driftFrequency: number;
      phase: number;
      rotation: number;
      rotationSpeed: number;
    }

    const particles: Particle[] = [];

    // Full logo path from logo.svg
    const logoPath = `M56.106,156.033c0,-35.468 20.862,-93.125 34.214,-109.094c13.029,-15.583 46.9,-14.363 61.263,0c95.023,95.023 34.214,73.626 34.214,109.094c0,35.467 -29.056,64.263 -64.846,64.263c-35.789,0 -64.845,-28.796 -64.845,-64.263Zm94.953,-69.717c3.355,0 6.079,2.724 6.079,6.079c0,3.355 -2.724,6.079 -6.079,6.079c-3.355,0 -6.079,-2.724 -6.079,-6.079c0,-3.355 2.724,-6.079 6.079,-6.079Zm-30.396,-48.585c13.421,0 24.317,3.632 24.317,8.106c0,4.473 -10.896,8.105 -24.317,8.105c-13.421,0 -24.318,-3.632 -24.318,-8.105c0,-4.474 10.897,-8.106 24.318,-8.106Z`;

    function createParticle(startFromBottom = true): Particle {
      const rect = playground.getBoundingClientRect();
      const size = 40 + Math.random() * 40;

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 256 256');
      svg.setAttribute('width', size.toString());
      svg.setAttribute('height', size.toString());
      svg.classList.add('logo-particle');

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', logoPath);
      svg.appendChild(path);

      playground.appendChild(svg);

      const baseX = Math.random() * rect.width;
      return {
        el: svg,
        x: baseX,
        y: startFromBottom ? rect.height + size : Math.random() * rect.height,
        baseX,
        size,
        baseOpacity: 0.15 + Math.random() * 0.35,
        riseSpeed: 0.3 + Math.random() * 0.5,
        driftAmplitude: 15 + Math.random() * 25,
        driftFrequency: 0.5 + Math.random() * 1,
        phase: Math.random() * Math.PI * 2,
        rotation: Math.random() * 360,
        rotationSpeed: (Math.random() - 0.5) * 0.5
      };
    }

    // Create initial particles distributed across height
    const rect = playground.getBoundingClientRect();
    for (let i = 0; i < PARTICLE_COUNT; i++) {
      const p = createParticle(false);
      p.y = (i / PARTICLE_COUNT) * rect.height + Math.random() * 50;
      particles.push(p);
    }

    let mouseX = -1000;
    let mouseY = -1000;
    let time = 0;

    playground.addEventListener('mousemove', (e) => {
      const r = playground.getBoundingClientRect();
      mouseX = e.clientX - r.left;
      mouseY = e.clientY - r.top;
    });

    playground.addEventListener('mouseleave', () => {
      mouseX = -1000;
      mouseY = -1000;
    });

    function animate() {
      time += 0.016;
      const rect = playground.getBoundingClientRect();

      particles.forEach((p) => {
        // Rise upward
        p.y -= p.riseSpeed;

        // Horizontal drift (sine wave)
        const drift = Math.sin(time * p.driftFrequency + p.phase) * p.driftAmplitude;
        p.x = p.baseX + drift;

        // Mouse repulsion
        if (mouseX > 0 && mouseY > 0) {
          const dx = p.x - mouseX;
          const dy = p.y - mouseY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 80) {
            const force = (80 - dist) / 80 * 15;
            p.x += (dx / dist) * force;
          }
        }

        // Gentle rotation
        p.rotation += p.rotationSpeed;

        // Opacity based on vertical position (fade near top)
        const heightRatio = p.y / rect.height;
        const opacity = p.baseOpacity * Math.min(1, heightRatio * 1.5);

        // Reset when reaching top
        if (p.y < -p.size) {
          p.y = rect.height + p.size;
          p.baseX = Math.random() * rect.width;
          p.x = p.baseX;
          p.phase = Math.random() * Math.PI * 2;
        }

        // Keep within horizontal bounds
        p.x = Math.max(0, Math.min(rect.width - p.size, p.x));

        // Apply styles
        p.el.style.opacity = opacity.toString();
        p.el.style.transform = `translate(${p.x - p.size/2}px, ${p.y - p.size/2}px) rotate(${p.rotation}deg)`;
      });

      requestAnimationFrame(animate);
    }

    animate();
  }

  // Initialize on load and page transitions
  initLogoAnimation();
  document.addEventListener('astro:page-load', initLogoAnimation);
</script>
